apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: create-user-job
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-create-user-job
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: run-airflow-migrations
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-migrate-database-job
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: redis
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-redis
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: scheduler
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-scheduler
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: statsd
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-statsd
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: triggerer
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-triggerer
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: webserver
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-webserver
  namespace: deeppharmgraph
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    chart: airflow-1.11.0
    component: worker
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-worker
  namespace: deeppharmgraph
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    chart: airflow-1.11.0
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-pod-launcher-role
  namespace: deeppharmgraph
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - create
  - list
  - get
  - patch
  - watch
  - delete
- apiGroups:
  - ""
  resources:
  - pods/log
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - pods/exec
  verbs:
  - create
  - get
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    chart: airflow-1.11.0
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-pod-log-reader-role
  namespace: deeppharmgraph
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - list
  - get
  - watch
- apiGroups:
  - ""
  resources:
  - pods/log
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    chart: airflow-1.11.0
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-pod-launcher-rolebinding
  namespace: deeppharmgraph
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dpg-processing-airflow-pod-launcher-role
subjects:
- kind: ServiceAccount
  name: dpg-processing-airflow-worker
  namespace: deeppharmgraph
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    chart: airflow-1.11.0
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-pod-log-reader-rolebinding
  namespace: deeppharmgraph
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: dpg-processing-airflow-pod-log-reader-role
subjects:
- kind: ServiceAccount
  name: dpg-processing-airflow-webserver
  namespace: deeppharmgraph
- kind: ServiceAccount
  name: dpg-processing-airflow-triggerer
  namespace: deeppharmgraph
---
apiVersion: v1
data:
  airflow.cfg: "[celery]\nflower_url_prefix = \nworker_concurrency = 16\n\n[celery_kubernetes_executor]\nkubernetes_queue
    = kubernetes\n\n[core]\ncolored_console_log = False\ndags_folder = /opt/airflow/dags\nexecutor
    = CeleryExecutor\nload_examples = False\nremote_logging = False\n\n[elasticsearch]\njson_format
    = True\nlog_id_template = {dag_id}_{task_id}_{execution_date}_{try_number}\n\n[elasticsearch_configs]\nmax_retries
    = 3\nretry_timeout = True\ntimeout = 30\n\n[kerberos]\nccache = /var/kerberos-ccache/cache\nkeytab
    = /etc/airflow.keytab\nprincipal = airflow@FOO.COM\nreinit_frequency = 3600\n\n[kubernetes]\nairflow_configmap
    = dpg-processing-airflow-config\nairflow_local_settings_configmap = dpg-processing-airflow-config\nmulti_namespace_mode
    = False\nnamespace = deeppharmgraph\npod_template_file = /opt/airflow/pod_templates/pod_template_file.yaml\nworker_container_repository
    = apache/airflow\nworker_container_tag = 2.7.1\n\n[kubernetes_executor]\nmulti_namespace_mode
    = False\nnamespace = deeppharmgraph\npod_template_file = /opt/airflow/pod_templates/pod_template_file.yaml\nworker_container_repository
    = apache/airflow\nworker_container_tag = 2.7.1\n\n[logging]\ncolored_console_log
    = False\nremote_logging = False\n\n[metrics]\nstatsd_host = dpg-processing-airflow-statsd\nstatsd_on
    = True\nstatsd_port = 9125\nstatsd_prefix = airflow\n\n[scheduler]\nrun_duration
    = 41460\nstandalone_dag_processor = False\nstatsd_host = dpg-processing-airflow-statsd\nstatsd_on
    = True\nstatsd_port = 9125\nstatsd_prefix = airflow\n\n[triggerer]\ndefault_capacity
    = 1000\n\n[webserver]\nenable_proxy_fix = True\nrbac = True"
  airflow_local_settings.py: |2-

    from airflow.www.utils import UIAlert

    DASHBOARD_UIALERTS = [
      UIAlert(
        'Usage of a dynamic webserver secret key detected. We recommend a static webserver secret key instead.'
        ' See the <a href='
        '"https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#webserver-secret-key">'
        'Helm Chart Production Guide</a> for more details.',
        category="warning",
        roles=["Admin"],
        html=True,
      )
    ]
kind: ConfigMap
metadata:
  labels:
    chart: airflow-1.11.0
    component: config
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-config
  namespace: deeppharmgraph
---
apiVersion: v1
data:
  mappings.yml: |-
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #   http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    ---
    mappings:
      # Map dot separated stats to labels
      - match: airflow.dagrun.dependency-check.*.*
        name: "airflow_dagrun_dependency_check"
        labels:
          dag_id: "$1"

      - match: airflow.operator_successes_(.*)
        match_type: regex
        name: "airflow_operator_successes"
        labels:
          operator: "$1"

      - match: airflow.operator_failures_(.*)
        match_type: regex
        name: "airflow_operator_failures"
        labels:
          operator: "$1"

      - match: airflow.scheduler_heartbeat
        match_type: regex
        name: "airflow_scheduler_heartbeat"
        labels:
          type: counter

      - match: airflow.dag.*.*.duration
        name: "airflow_task_duration"
        labels:
          dag_id: "$1"
          task_id: "$2"

      - match: airflow.dagrun.duration.success.*
        name: "airflow_dagrun_duration"
        labels:
          dag_id: "$1"

      - match: airflow.dagrun.duration.failed.*
        name: "airflow_dagrun_failed"
        labels:
          dag_id: "$1"

      - match: airflow.dagrun.schedule_delay.*
        name: "airflow_dagrun_schedule_delay"
        labels:
          dag_id: "$1"

      - match: airflow.dag_processing.last_runtime.*
        name: "airflow_dag_processing_last_runtime"
        labels:
          dag_file: "$1"

      - match: airflow.dag_processing.last_run.seconds_ago.*
        name: "airflow_dag_processing_last_run_seconds_ago"
        labels:
          dag_file: "$1"

      - match: airflow.pool.open_slots.*
        name: "airflow_pool_open_slots"
        labels:
          pool: "$1"

      - match: airflow.pool.used_slots.*
        name: "airflow_pool_used_slots"
        labels:
          pool: "$1"

      - match: airflow.pool.starving_tasks.*
        name: "airflow_pool_starving_tasks"
        labels:
          pool: "$1"
kind: ConfigMap
metadata:
  labels:
    chart: airflow-1.11.0
    component: config
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-statsd
  namespace: deeppharmgraph
---
apiVersion: v1
data:
  connection: cmVkaXM6Ly86MkNTcVA1U0NxMkBkcGctcHJvY2Vzc2luZy1haXJmbG93LXJlZGlzOjYzNzkvMA==
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    component: redis
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-broker-url
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
data:
  fernet-key: YzNjemRsUXllRWhDY0ZBNFRWZFpRV3htZWpVeWVIaEpjVzFLU0VwRGFEQT0=
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-fernet-key
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
data:
  connection: cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBvc3RncmVzQGRwZy1wcm9jZXNzaW5nLWFpcmZsb3ctcG9zdGdyZXNxbC5kZWVwcGhhcm1ncmFwaDo1NDMyL3Bvc3RncmVzP3NzbG1vZGU9ZGlzYWJsZQ==
kind: Secret
metadata:
  labels:
    chart: airflow
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-metadata
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
data:
  postgres-password: cG9zdGdyZXM=
kind: Secret
metadata:
  labels:
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    helm.sh/chart: postgresql-12.10.0
  name: dpg-processing-airflow-postgresql
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
data:
  password: MkNTcVA1U0NxMg==
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: before-hook-creation
    helm.sh/hook-weight: "0"
  labels:
    chart: airflow
    component: redis
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-redis-password
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
data:
  webserver-secret-key: ZVZZelVXRkRibWM1V1ZkWVYwSjBiSEU1UlRWQ2VYVkNRMWhyTkRSM1ZFRT0=
kind: Secret
metadata:
  labels:
    chart: airflow
    component: webserver
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-webserver-secret-key
  namespace: deeppharmgraph
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    helm.sh/chart: postgresql-12.10.0
  name: dpg-processing-airflow-postgresql
  namespace: deeppharmgraph
spec:
  ports:
  - name: tcp-postgresql
    nodePort: null
    port: 5432
    targetPort: tcp-postgresql
  selector:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/name: postgresql
  sessionAffinity: None
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    helm.sh/chart: postgresql-12.10.0
  name: dpg-processing-airflow-postgresql-hl
  namespace: deeppharmgraph
spec:
  clusterIP: None
  ports:
  - name: tcp-postgresql
    port: 5432
    targetPort: tcp-postgresql
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/name: postgresql
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.11.0
    component: redis
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-redis
  namespace: deeppharmgraph
spec:
  ports:
  - name: redis-db
    port: 6379
    protocol: TCP
    targetPort: 6379
  selector:
    component: redis
    release: dpg-processing-airflow
    tier: airflow
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: "9102"
    prometheus.io/scrape: "true"
  labels:
    chart: airflow-1.11.0
    component: statsd
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-statsd
  namespace: deeppharmgraph
spec:
  ports:
  - name: statsd-ingest
    port: 9125
    protocol: UDP
    targetPort: 9125
  - name: statsd-scrape
    port: 9102
    protocol: TCP
    targetPort: 9102
  selector:
    component: statsd
    release: dpg-processing-airflow
    tier: airflow
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.11.0
    component: triggerer
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-triggerer
  namespace: deeppharmgraph
spec:
  clusterIP: None
  ports:
  - name: triggerer-logs
    port: 8794
    protocol: TCP
    targetPort: 8794
  selector:
    component: triggerer
    release: dpg-processing-airflow
    tier: airflow
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.11.0
    component: webserver
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-webserver
  namespace: deeppharmgraph
spec:
  ports:
  - name: airflow-ui
    port: 8080
  selector:
    component: webserver
    release: dpg-processing-airflow
    tier: airflow
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: airflow-1.11.0
    component: worker
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-worker
  namespace: deeppharmgraph
spec:
  clusterIP: None
  ports:
  - name: worker-logs
    port: 8793
    protocol: TCP
    targetPort: 8793
  selector:
    component: worker
    release: dpg-processing-airflow
    tier: airflow
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.11.0
    component: scheduler
    executor: CeleryExecutor
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-scheduler
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      component: scheduler
      release: dpg-processing-airflow
      tier: airflow
  template:
    metadata:
      annotations:
        checksum/airflow-config: 2e382953577688a2e287f58e544377000906659cd23568a9cc64305be0721cb7
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: dad4ec6d9c48fb2745f5c1979e881d4150a6db4a17c131649643d407ce705a9d
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        checksum/result-backend-secret: 98a68f230007cfa8f5d3792e1aff843a76b0686409e4a46ab2f092f6865a1b71
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: scheduler
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: scheduler
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow scheduler
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type SchedulerJob --local
          failureThreshold: 5
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 20
        name: scheduler
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type SchedulerJob --local
          failureThreshold: 6
          periodSeconds: 10
          timeoutSeconds: 20
        volumeMounts:
        - mountPath: /opt/airflow/pod_templates/pod_template_file.yaml
          name: config
          readOnly: true
          subPath: pod_template_file.yaml
        - mountPath: /opt/airflow/logs
          name: logs
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      - args:
        - bash
        - /clean-logs
        env:
        - name: AIRFLOW__LOG_RETENTION_DAYS
          value: "15"
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: scheduler-log-groomer
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-scheduler
      terminationGracePeriodSeconds: 10
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
      - emptyDir: {}
        name: logs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.11.0
    component: statsd
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-statsd
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      component: statsd
      release: dpg-processing-airflow
      tier: airflow
  template:
    metadata:
      labels:
        component: statsd
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - --statsd.mapping-config=/etc/statsd-exporter/mappings.yml
        image: quay.io/prometheus/statsd-exporter:v0.22.8
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9102
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        name: statsd
        ports:
        - containerPort: 9125
          name: statsd-ingest
          protocol: UDP
        - containerPort: 9102
          name: statsd-scrape
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9102
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /etc/statsd-exporter/mappings.yml
          name: config
          subPath: mappings.yml
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        runAsUser: 65534
      serviceAccountName: dpg-processing-airflow-statsd
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-statsd
        name: config
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    chart: airflow-1.11.0
    component: webserver
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-webserver
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      component: webserver
      release: dpg-processing-airflow
      tier: airflow
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/airflow-config: 2e382953577688a2e287f58e544377000906659cd23568a9cc64305be0721cb7
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: dad4ec6d9c48fb2745f5c1979e881d4150a6db4a17c131649643d407ce705a9d
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        checksum/webserver-config: 2f3fdfd294a37094d2abee43b2b09888a5c195ee03414996bf99a4681658af94
        checksum/webserver-secret-key: ee657958bb694227e099493a6e4489a94cf03ab406b3888f9c6302b5ed5f4271
      labels:
        component: webserver
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: webserver
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow webserver
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
        name: webserver
        ports:
        - containerPort: 8080
          name: airflow-ui
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        startupProbe:
          failureThreshold: 6
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          periodSeconds: 10
          timeoutSeconds: 20
        volumeMounts:
        - mountPath: /opt/airflow/pod_templates/pod_template_file.yaml
          name: config
          readOnly: true
          subPath: pod_template_file.yaml
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-webserver
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: primary
    app.kubernetes.io/instance: dpg-processing-airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgresql
    helm.sh/chart: postgresql-12.10.0
  name: dpg-processing-airflow-postgresql
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: primary
      app.kubernetes.io/instance: dpg-processing-airflow
      app.kubernetes.io/name: postgresql
  serviceName: dpg-processing-airflow-postgresql-hl
  template:
    metadata:
      labels:
        app.kubernetes.io/component: primary
        app.kubernetes.io/instance: dpg-processing-airflow
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: postgresql
        helm.sh/chart: postgresql-12.10.0
      name: dpg-processing-airflow-postgresql
    spec:
      affinity:
        nodeAffinity: null
        podAffinity: null
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: primary
                  app.kubernetes.io/instance: dpg-processing-airflow
                  app.kubernetes.io/name: postgresql
              topologyKey: kubernetes.io/hostname
            weight: 1
      containers:
      - env:
        - name: BITNAMI_DEBUG
          value: "false"
        - name: POSTGRESQL_PORT_NUMBER
          value: "5432"
        - name: POSTGRESQL_VOLUME_DIR
          value: /bitnami/postgresql
        - name: PGDATA
          value: /bitnami/postgresql/data
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: postgres-password
              name: dpg-processing-airflow-postgresql
        - name: POSTGRESQL_ENABLE_LDAP
          value: "no"
        - name: POSTGRESQL_ENABLE_TLS
          value: "no"
        - name: POSTGRESQL_LOG_HOSTNAME
          value: "false"
        - name: POSTGRESQL_LOG_CONNECTIONS
          value: "false"
        - name: POSTGRESQL_LOG_DISCONNECTIONS
          value: "false"
        - name: POSTGRESQL_PGAUDIT_LOG_CATALOG
          value: "off"
        - name: POSTGRESQL_CLIENT_MIN_MESSAGES
          value: error
        - name: POSTGRESQL_SHARED_PRELOAD_LIBRARIES
          value: pgaudit
        image: docker.io/bitnami/postgresql:11
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U "postgres" -h 127.0.0.1 -p 5432
          failureThreshold: 6
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        name: postgresql
        ports:
        - containerPort: 5432
          name: tcp-postgresql
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - -e
            - |
              exec pg_isready -U "postgres" -h 127.0.0.1 -p 5432
              [ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]
          failureThreshold: 6
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        resources:
          limits: {}
          requests:
            cpu: 250m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsGroup: 0
          runAsNonRoot: true
          runAsUser: 1001
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - mountPath: /dev/shm
          name: dshm
        - mountPath: /bitnami/postgresql
          name: data
      hostIPC: false
      hostNetwork: false
      securityContext:
        fsGroup: 1001
      serviceAccountName: default
      volumes:
      - emptyDir:
          medium: Memory
        name: dshm
  updateStrategy:
    rollingUpdate: {}
    type: RollingUpdate
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 8Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    chart: airflow-1.11.0
    component: redis
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-redis
  namespace: deeppharmgraph
spec:
  selector:
    matchLabels:
      component: redis
      release: dpg-processing-airflow
      tier: airflow
  serviceName: dpg-processing-airflow-redis
  template:
    metadata:
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: redis
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - -c
        - redis-server --requirepass ${REDIS_PASSWORD}
        command:
        - /bin/sh
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: dpg-processing-airflow-redis-password
        image: redis:7-bullseye
        imagePullPolicy: IfNotPresent
        name: redis
        ports:
        - containerPort: 6379
          name: redis-db
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /data
          name: redis-db
      nodeSelector: {}
      securityContext:
        runAsUser: 0
      serviceAccountName: dpg-processing-airflow-redis
      tolerations: []
      topologySpreadConstraints: []
  volumeClaimTemplates:
  - metadata:
      name: redis-db
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: block-replicated
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    chart: airflow-1.11.0
    component: triggerer
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-triggerer
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      component: triggerer
      release: dpg-processing-airflow
      tier: airflow
  serviceName: dpg-processing-airflow-triggerer
  template:
    metadata:
      annotations:
        checksum/airflow-config: 2e382953577688a2e287f58e544377000906659cd23568a9cc64305be0721cb7
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/metadata-secret: dad4ec6d9c48fb2745f5c1979e881d4150a6db4a17c131649643d407ce705a9d
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: triggerer
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: triggerer
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - exec airflow triggerer
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              CONNECTION_CHECK_MAX_COUNT=0 AIRFLOW__LOGGING__LOGGING_LEVEL=ERROR exec /entrypoint \
              airflow jobs check --job-type TriggererJob --local
          failureThreshold: 5
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 20
        name: triggerer
        ports:
        - containerPort: 8794
          name: triggerer-logs
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      - args:
        - bash
        - /clean-logs
        env:
        - name: AIRFLOW__LOG_RETENTION_DAYS
          value: "15"
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: triggerer-log-groomer
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-triggerer
      terminationGracePeriodSeconds: 60
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
  volumeClaimTemplates:
  - metadata:
      name: logs
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: block-replicated
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    chart: airflow-1.11.0
    component: worker
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-worker
  namespace: deeppharmgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      component: worker
      release: dpg-processing-airflow
      tier: airflow
  serviceName: dpg-processing-airflow-worker
  template:
    metadata:
      annotations:
        checksum/airflow-config: 2e382953577688a2e287f58e544377000906659cd23568a9cc64305be0721cb7
        checksum/extra-configmaps: e862ea47e13e634cf17d476323784fa27dac20015550c230953b526182f5cac8
        checksum/extra-secrets: e9582fdd622296c976cbc10a5ba7d6702c28a24fe80795ea5b84ba443a56c827
        checksum/kerberos-keytab: 80979996aa3c1f48c95dfbe9bb27191e71f12442a08c0ed834413da9d430fd0e
        checksum/metadata-secret: dad4ec6d9c48fb2745f5c1979e881d4150a6db4a17c131649643d407ce705a9d
        checksum/pgbouncer-config-secret: 1dae2adc757473469686d37449d076b0c82404f61413b58ae68b3c5e99527688
        checksum/result-backend-secret: 98a68f230007cfa8f5d3792e1aff843a76b0686409e4a46ab2f092f6865a1b71
        checksum/webserver-secret-key: 85a4370b026c8d34c0c45341e1103fe25b36993ef3dfd48f6064b8d524cfcdd5
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
      labels:
        component: worker
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: worker
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - args:
        - bash
        - -c
        - |-
          exec \
          airflow celery worker
        env:
        - name: DUMB_INIT_SETSID
          value: "0"
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - CONNECTION_CHECK_MAX_COUNT=0 exec /entrypoint python -m celery --app
              airflow.providers.celery.executors.celery_executor.app inspect ping
              -d celery@$(hostname)
          failureThreshold: 5
          initialDelaySeconds: 10
          periodSeconds: 60
          timeoutSeconds: 20
        name: worker
        ports:
        - containerPort: 8793
          name: worker-logs
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      - args:
        - bash
        - /clean-logs
        env:
        - name: AIRFLOW__LOG_RETENTION_DAYS
          value: "15"
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: worker-log-groomer
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/logs
          name: logs
      initContainers:
      - args:
        - airflow
        - db
        - check-migrations
        - --migration-wait-timeout=60
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: wait-for-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: Always
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-worker
      terminationGracePeriodSeconds: 600
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
  volumeClaimTemplates:
  - metadata:
      name: logs
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: block-replicated
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "2"
  labels:
    chart: airflow-1.11.0
    component: create-user-job
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-create-user
  namespace: deeppharmgraph
spec:
  template:
    metadata:
      labels:
        component: create-user-job
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - bash
        - -c
        - |-
          exec \
          airflow users create "$@"
        - --
        - -r
        - Admin
        - -u
        - admin
        - -e
        - admin@example.com
        - -f
        - admin
        - -l
        - user
        - -p
        - admin
        env:
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: create-user
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-create-user-job
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
  ttlSecondsAfterFinished: 300
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: "1"
  labels:
    chart: airflow-1.11.0
    component: run-airflow-migrations
    heritage: Helm
    release: dpg-processing-airflow
    tier: airflow
  name: dpg-processing-airflow-run-airflow-migrations
  namespace: deeppharmgraph
spec:
  template:
    metadata:
      labels:
        component: run-airflow-migrations
        release: dpg-processing-airflow
        tier: airflow
    spec:
      affinity: {}
      containers:
      - args:
        - bash
        - -c
        - |-
          exec \
          airflow db migrate
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: AIRFLOW__CORE__FERNET_KEY
          valueFrom:
            secretKeyRef:
              key: fernet-key
              name: dpg-processing-airflow-fernet-key
        - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW_CONN_AIRFLOW_DB
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-metadata
        - name: AIRFLOW__WEBSERVER__SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: webserver-secret-key
              name: dpg-processing-airflow-webserver-secret-key
        - name: AIRFLOW__CELERY__BROKER_URL
          valueFrom:
            secretKeyRef:
              key: connection
              name: dpg-processing-airflow-broker-url
        envFrom: []
        image: apache/airflow:2.7.1
        imagePullPolicy: IfNotPresent
        name: run-airflow-migrations
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - mountPath: /opt/airflow/airflow.cfg
          name: config
          readOnly: true
          subPath: airflow.cfg
        - mountPath: /opt/airflow/config/airflow_local_settings.py
          name: config
          readOnly: true
          subPath: airflow_local_settings.py
      nodeSelector: {}
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 0
        runAsUser: 50000
      serviceAccountName: dpg-processing-airflow-migrate-database-job
      tolerations: []
      topologySpreadConstraints: []
      volumes:
      - configMap:
          name: dpg-processing-airflow-config
        name: config
  ttlSecondsAfterFinished: 300
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: http-processing-webserver
  namespace: deeppharmgraph
spec:
  hostnames:
  - dpg-processing.shamrock.systems
  parentRefs:
  - name: http-gateway
    namespace: kube-system
  rules:
  - backendRefs:
    - name: dpg-processing-airflow-webserver
      port: 8080
    matches:
    - path:
        type: PathPrefix
        value: /
